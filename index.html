<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mandelbrot</title>
  <script src="mandelbrot.js"></script>
</head>
<body>
  <canvas id="canvas" width="1280" height="720"></canvas>
  <script>
      const N = 8;  // Parallel chunks to render (must be a multiple of height)
      const canvas = document.getElementById('canvas');
      let posX = 0;
      let posY = 0;

      window.addEventListener('load', function(e) {
          if (!window.Worker) {
              window.alert('Sorry! This browser does not support web workers');
              return;
          }

          draw(2 / 3 * canvas.width, canvas.height / 2, 300);
      });

      canvas.addEventListener('click', function (e) {
          posX += canvas.width / 2 - e.offsetX;
          posY += canvas.height / 2 - e.offsetY;

          draw(2 / 3 * canvas.width + posX, canvas.height / 2 + posY, 300);
      });

      function draw(offsetX, offsetY, scale) {
          const ctx = canvas.getContext('2d');

          ctx.font = '12px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Rendering fractal...', canvas.width / 2, canvas.height / 2);

          const chunkWidth = canvas.width;
          const chunkHeight = canvas.height / N;
          for (let i = 0; i < 1; i++) {
              for (let j = 0; j < N; j++) {
                  const y = j * chunkHeight;

                  const options = {
                      scale: scale,
                      offsetX: offsetX,
                      offsetY: offsetY - y,
                  };

                  drawMandelbrot(ctx, chunkWidth, chunkHeight, options, function (imageData) {
                      // Draw completed fractal
                      ctx.putImageData(imageData, 0, y);
                  });
              }
          }
      }

      function drawMandelbrot(ctx, width, height, options, cb) {
          const worker = new Worker('mandelbrot.js');
          worker.onmessage = function(e) {
              cb(e.data);
          };

          // Start rendering
          worker.postMessage([width, height, options]);
      }
  </script>
</body>
</html>
