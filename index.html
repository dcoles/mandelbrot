<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mandelbrot</title>
  <script src="mandelbrot.js"></script>
</head>
<body>
  <canvas id="canvas" width="1280" height="720"></canvas>
  <script>
      const canvas = document.getElementById('canvas');

      const N = 8;  // Parallel chunks to render (must be a multiple of height)
      const midX = canvas.width / 2;
      const midY = canvas.height / 2;
      const zoomFactor = Math.E;

      let posX = 0;
      let posY = 0;
      let scale = 300;

      window.addEventListener('load', function(e) {
          if (!window.Worker) {
              window.alert('Sorry! This browser does not support web workers');
              return;
          }

          draw();
      });

      canvas.addEventListener('mouseup', function (e) {
          if (e.button > 1) {
              // Only handle left/middle click
              return false;
          }

          if (e.button === 0) {
              // Left click
              scale *= zoomFactor;
              posX = zoomFactor * (posX + midX - e.offsetX);
              posY = zoomFactor * (posY + midY - e.offsetY);
          } else {
              // Middle click
              posX += midX - e.offsetX;
              posY += midY - e.offsetY;
          }

          draw(posX, posY, scale);
      });

      function draw() {
          const ctx = canvas.getContext('2d');

          ctx.font = '12px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Rendering fractal...', canvas.width / 2, canvas.height / 2);

          const chunkWidth = canvas.width;
          const chunkHeight = canvas.height / N;
          for (let i = 0; i < 1; i++) {
              for (let j = 0; j < N; j++) {
                  const y = j * chunkHeight;

                  const options = {
                      scale: scale,
                      offsetX: midX + posX,
                      offsetY: midY + posY - y,
                  };

                  drawMandelbrot(ctx, chunkWidth, chunkHeight, options, function (imageData) {
                      // Draw completed fractal
                      ctx.putImageData(imageData, 0, y);
                  });
              }
          }
      }

      function drawMandelbrot(ctx, width, height, options, cb) {
          const worker = new Worker('mandelbrot.js');
          worker.onmessage = function(e) {
              cb(e.data);
          };

          // Start rendering
          worker.postMessage([width, height, options]);
      }
  </script>
</body>
</html>
