<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blue Dragon Fire</title>
  <script src="mandelbrot.js"></script>
  <link rel="icon" type="image/jpeg" href="favicon.jpg">
</head>
<body>
  <canvas id="canvas" width="1280" height="720"></canvas>
  <script>
      const canvas = document.getElementById('canvas');

      const N = 8;  // Parallel chunks to render (must be a multiple of height)
      const midX = canvas.width / 2;
      const midY = canvas.height / 2;
      const initialZoom = 300;
      const zoomFactor = 2;

      let posX = 0;
      let posY = 0;
      let zoom = 1;
      let busy = 0;  // Number of busy workers

      window.addEventListener('load', function(e) {
          if (!window.Worker) {
              window.alert('Sorry! This browser does not support web workers');
              return;
          }

          parseHash();
          draw();
      });

      window.addEventListener('hashchange', function(event) {
          if (busy) {
              return;
          }

          parseHash();
          draw();
      });

      canvas.addEventListener('mouseup', function (event) {
          if (busy) {
              return;
          }

          if (event.button > 1) {
              // Only handle left/middle click
              return false;
          }

          if (event.button === 0) {
              // Left click
              zoom *= zoomFactor;
          }

          posX += (midX - event.offsetX) / zoom;
          posY += (midY - event.offsetY) / zoom;

          draw();
      });

      function parseHash() {
          const xyscale = window.location.hash.split('@', 2);
          const xy = xyscale[0].split(',', 2);

          zoom = parseInt(xyscale[1]) || 1;
          posX = parseFloat(xy[0]) || 0;
          posY = parseFloat(xy[1]) || 0;
      }

      function updateHash() {
          const hash = `#${posX},${posY}@${zoom}`;
          window.history.pushState(null, '', hash);
      }

      function draw() {
          const ctx = canvas.getContext('2d');

          ctx.font = '12px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillStyle = 'white';
          ctx.fillRect(midX - 60, midY - 13, 120, 19);
          ctx.fillStyle = 'black';
          ctx.fillText('Rendering fractal...', midX, midY);

          updateHash();

          const chunkWidth = canvas.width;
          const chunkHeight = canvas.height / N;
          for (let i = 0; i < 1; i++) {
              for (let j = 0; j < N; j++) {
                  const y = j * chunkHeight;

                  const options = {
                      scale: initialZoom * zoom,
                      offsetX: midX + (posX * zoom),
                      offsetY: midY + (posY * zoom) - y,
                  };

                  busy += 1;
                  drawMandelbrot(ctx, chunkWidth, chunkHeight, options, function (imageData) {
                      // Draw completed fractal
                      ctx.putImageData(imageData, 0, y);
                      busy -= 1;
                  });
              }
          }
      }

      function drawMandelbrot(ctx, width, height, options, cb) {
          const worker = new Worker('mandelbrot.js');
          worker.onmessage = function(e) {
              cb(e.data);
          };

          // Start rendering
          worker.postMessage([width, height, options]);
      }
  </script>
</body>
</html>
