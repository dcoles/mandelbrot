<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blue Dragon Fire</title>
  <script src="mandelbrot.js"></script>
  <link rel="icon" type="image/jpeg" href="favicon.jpg">
</head>
<body style="padding: 0; margin: 0; background: black;">
  <canvas id="canvas" width="1280" height="720" style="position: absolute;"></canvas>
  <script>
      const canvas = document.getElementById('canvas');

      const N = 8;  // Parallel chunks to render (must be a multiple of height)
      const initialZoom = 300;
      const zoomFactor = 2;

      let posX = 0;
      let posY = 0;
      let zoom = 1;
      let timeout = null;
      let workers = [];
      let generation = 0;

      window.addEventListener('load', function() {
          if (!window.Worker) {
              window.alert('Sorry! This browser does not support web workers');
              return;
          }

          parseHash();
          updateCanvasSize();
          draw();
      });

      window.addEventListener('hashchange', function() {
          parseHash();
          draw();
      });

      window.addEventListener('resize', function() {
          updateCanvasSize();
          draw();
      });

      canvas.addEventListener('mouseup', function(event) {
          if (event.button > 1) {
              // Only handle left/middle click
              return false;
          }

          if (event.button === 0) {
              // Left click
              zoom *= zoomFactor;
          }

          posX += (canvas.width / 2 - event.offsetX) / zoom;
          posY += (canvas.height / 2 - event.offsetY) / zoom;

          draw();
      });

      function parseHash() {
          const xyscale = window.location.hash.split('@', 2);
          const xy = xyscale[0].split(',', 2);

          zoom = parseInt(xyscale[1]) || 1;
          posX = parseFloat(xy[0]) || 0;
          posY = parseFloat(xy[1]) || 0;
      }

      function updateCanvasSize() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
      }

      function updateHash() {
          const hash = `#${posX},${posY}@${zoom}`;
          window.history.pushState(null, '', hash);
      }

      function draw() {
          const ctx = canvas.getContext('2d');
          const midX = canvas.width / 2;
          const midY = canvas.height / 2;

          ctx.font = '12px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillStyle = '#ffffffcc';
          ctx.fillRect(midX - 60, midY - 13, 120, 19);
          ctx.strokeRect(midX - 60, midY - 13, 120, 19);
          ctx.fillStyle = '#000000';
          ctx.fillText('Rendering fractal...', midX, midY);

          updateHash();

          clearTimeout(timeout);
          timeout = setTimeout(function() {
              // Kill any remaining workers
              do {
                  let worker = workers.pop();
                  if (worker === undefined) {
                      break;
                  }
              } while (true);

              // Update the generation
              generation += 1;
              const thisGeneration = generation;

              const chunkWidth = canvas.width;
              // Image length must be a multiple of 4
              const chunkHeight = Math.floor(canvas.height / N / 4 + 1) * 4;
              for (let i = 0; i < 1; i++) {
                  for (let j = 0; j < N; j++) {
                      const y = j * chunkHeight;

                      const options = {
                          scale: initialZoom * zoom,
                          offsetX: midX + (posX * zoom),
                          offsetY: midY + (posY * zoom) - y,
                      };

                      const worker = drawMandelbrot(ctx, chunkWidth, chunkHeight, options, function (imageData) {
                          // Make sure we don't draw the wrong generation
                          if (generation !== thisGeneration) {
                              return;
                          }

                          // Draw completed fractal
                          ctx.putImageData(imageData, 0, y);
                      });
                      workers.push(worker);
                  }
              }

          }, 100);
      }

      function drawMandelbrot(ctx, width, height, options, cb) {
          const worker = new Worker('mandelbrot.js');
          worker.onmessage = function(e) {
              cb(e.data);
          };

          // Start rendering
          worker.postMessage([width, height, options]);
          return worker;
      }
  </script>
</body>
</html>
